# Настройка Telegram Webhook для кнопки отмены заказа курьером

## Обзор

Система теперь поддерживает кнопку "Отменить заказ" в сообщениях курьерам. При назначении курьера на заказ, ему приходит сообщение с inline-кнопкой для отмены заказа.

## История изменений

### v4 (Текущая версия) - Полная очистка заказа при отмене
- При отмене заказа курьером теперь полностью очищается вся информация о назначении
- Устанавливается `assignment_status: null` (статус "Назначить курьера")
- Очищаются все сообщения в Telegram: личное курьеру + все групповые сообщения
- Удаляются поля: `telegram_message_id`, `group_chat_message_id`, `group_info_message_id`, `courier_search_started_at`
- Заказ полностью возвращается в исходное состояние

### v3 - Автоматическая настройка webhook
- Добавлена edge function `setup-courier-webhook` для автоматической настройки webhook
- Добавлен UI в General Settings для настройки webhook в один клик
- Webhook теперь настраивается автоматически через админ-панель
- Добавлено логирование успешной настройки webhook

### v2 - Исправление ошибки "Сессия истекла"
- Исправлен порядок получения bot_token - теперь получается до проверки прав курьера
- Упрощена функция `answerCallbackQuery` - bot_token передается напрямую
- Добавлено подробное логирование в таблицу `logs` для отслеживания всех отмен
- Улучшена обработка ошибок с записью в логи
- Добавлен вывод результата deleteMessage в консоль для отладки

### v1 (Начальная версия)
- Базовая реализация кнопки отмены заказа
- Проверка прав курьера
- Удаление сообщения в Telegram

## Что было реализовано

### 1. Обновлена функция отправки сообщений
- **Файл**: `supabase/functions/send-telegram-message/index.ts`
- Добавлена поддержка `inline_keyboard` для создания кнопок в сообщениях

### 2. Создана edge function для обработки callback
- **Файл**: `supabase/functions/courier-cancel-webhook/index.ts`
- Обрабатывает нажатия на кнопку "Отменить заказ"
- Проверяет, что отменяет заказ именно назначенный курьер
- Снимает курьера с заказа
- Удаляет сообщение в Telegram

### 3. Обновлен код отправки сообщения курьеру
- **Файл**: `src/pages/partner/Orders.tsx`
- При назначении курьера добавляется inline-кнопка "❌ Отменить заказ"

### 4. Создана edge function для автоматической настройки webhook
- **Файл**: `supabase/functions/setup-courier-webhook/index.ts`
- Автоматически настраивает webhook для бота курьеров
- Проверяет наличие bot_token в настройках партнера
- Логирует успешную настройку

### 5. Добавлен UI для настройки webhook
- **Файл**: `src/pages/partner/GeneralSettings.tsx`
- Кнопка "Настроить Webhook для отмены заказов" в разделе General Settings
- Автоматическая настройка webhook в один клик

## Настройка Webhook

Для работы кнопки отмены необходимо настроить webhook для бота курьеров.

### Способ 1: Через интерфейс администратора (Рекомендуется)

1. Войдите в админ-панель партнера
2. Перейдите в раздел **Общие настройки** (General Settings)
3. Найдите секцию **Telegram-бот для курьеров**
4. Убедитесь, что заполнено поле **Токен бота**
5. Нажмите кнопку **"Настроить Webhook для отмены заказов"**
6. Дождитесь сообщения об успешной установке

Готово! Webhook настроен автоматически.

### Способ 2: Вручную через API (Для продвинутых пользователей)

#### Шаг 1: Получите URL вашей edge function

URL будет иметь формат:
\`\`\`
https://[ваш-проект].supabase.co/functions/v1/courier-cancel-webhook
\`\`\`

#### Шаг 2: Установите webhook для бота

Выполните HTTP запрос к Telegram API:

\`\`\`bash
curl -X POST "https://api.telegram.org/bot[BOT_TOKEN]/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://[ваш-проект].supabase.co/functions/v1/courier-cancel-webhook",
    "allowed_updates": ["callback_query"],
    "drop_pending_updates": true
  }'
\`\`\`

Замените:
- `[BOT_TOKEN]` на токен вашего бота курьеров
- `[ваш-проект]` на ID вашего Supabase проекта

#### Шаг 3: Проверьте настройку webhook

\`\`\`bash
curl "https://api.telegram.org/bot[BOT_TOKEN]/getWebhookInfo"
\`\`\`

Вы должны увидеть:
\`\`\`json
{
  "ok": true,
  "result": {
    "url": "https://[ваш-проект].supabase.co/functions/v1/courier-cancel-webhook",
    "has_custom_certificate": false,
    "pending_update_count": 0
  }
}
\`\`\`

## Как работает система

1. **Назначение курьера**: При назначении курьера на заказ отправляется сообщение с кнопкой "❌ Отменить заказ"

2. **Нажатие кнопки**: Когда курьер нажимает кнопку:
   - Telegram отправляет callback_query на webhook
   - Edge function проверяет, что курьер назначен на этот заказ
   - Снимает курьера с заказа в БД
   - Удаляет личное сообщение курьеру
   - Удаляет все сообщения из группового чата (если были отправлены)
   - Очищает все поля связанные с назначением курьера
   - Устанавливает `assignment_status: null` (кнопка "Назначить курьера")
   - Заказ полностью возвращается в исходное состояние

3. **Безопасность**: Функция проверяет, что отменить может только назначенный курьер

4. **Что удаляется при отмене**:
   - Личное сообщение курьеру (`courier_message_id`)
   - Сообщение поиска курьера в группе (`telegram_message_id`)
   - Сообщение с информацией о заказе в группе (`group_chat_message_id`)
   - Информационное сообщение в группе (`group_info_message_id`)
   - Время начала поиска (`courier_search_started_at`)

## Структура callback_data

Кнопка содержит данные в формате:
\`\`\`
cancel_order_[order_id]
\`\`\`

Где `[order_id]` - это UUID заказа из базы данных.

## Troubleshooting

### Webhook не работает

1. Проверьте, что webhook установлен:
   \`\`\`bash
   curl "https://api.telegram.org/bot[BOT_TOKEN]/getWebhookInfo"
   \`\`\`

2. Проверьте логи edge function в Supabase Dashboard

3. Убедитесь, что в `partner_settings` указан правильный `courier_bot_token`

### Кнопка не появляется

1. Проверьте, что у курьера заполнено поле `telegram_user_id`
2. Убедитесь, что бот курьера имеет доступ к отправке сообщений курьеру

### Ошибка "Сессия истекла" при нажатии кнопки

Эта проблема была исправлена в последней версии. Edge function теперь:
- Получает bot_token из базы данных до проверки прав курьера
- Правильно обрабатывает answerCallbackQuery
- Добавляет подробное логирование всех действий в таблицу logs

Если проблема сохраняется:
1. Проверьте логи в Supabase Dashboard → Edge Functions → courier-cancel-webhook
2. Убедитесь, что edge function имеет доступ к таблице `orders` и `partner_settings`
3. Проверьте, что `SUPABASE_SERVICE_ROLE_KEY` настроен правильно
4. Убедитесь, что webhook настроен правильно (см. Шаг 2)

### Сообщение не удаляется

1. Проверьте в логах результат deleteMessage
2. Убедитесь, что бот имеет право удалять сообщения
3. Проверьте, что message_id сохранен правильно в базе данных
4. Проверьте логи в таблице `logs` - там записываются все действия по отмене заказа

## Дополнительные возможности

В будущем можно добавить:
- Подтверждение перед отменой
- Причину отмены
- Уведомление администратора об отмене
- История отмен курьером
